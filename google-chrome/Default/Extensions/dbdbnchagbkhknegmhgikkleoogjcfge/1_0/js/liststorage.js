var ListStorage=new function(){var e=this;e.Types={white:"white",black:"black"};var n=0,t=[];e.onChanged={},e.onChanged.addEventListener=function(e){t.push(e)},chrome.storage.onChanged.addListener(function(i,o){"sync"==o&&("list-"+e.Types.white in i&&(r.white=null),"list-"+e.Types.black in i&&(r.black=null),t.length>0&&(clearTimeout(n),n=setTimeout(function(){for(var e=0;e<t.length;e++)t[e]()},300)))}),e.getElements=function(e,n){chrome.storage.sync.get("list-"+e,function(t){var r=t["list-"+e];return r instanceof Array?n(null,r):n(null,[])})};var r={white:null,black:null};e.getGroupedElements=function(n,t){function i(n,t){e.getElements(n,function(i,o){for(var a={},l=0,u=o.length;l<u;l++)if(o[l].type==e.ItemTypes.domain){void 0==a.domains&&(a.domains={});var s=o[l].value[0]+o[l].value[1];void 0==a.domains[s]&&(a.domains[s]=[]),a.domains[s].push(o[l].value)}else o[l].type==e.ItemTypes.regexp&&(void 0==a.regexp&&(a.regexp=[]),a.regexp.push(o[l].value));r[n]=a,t(a)})}return null===r[n]?i(n,t):t(r[n])},e.generateId=function(){return"I"+Math.random().toString().replace(".","")},e.ItemTypes={domain:0,regexp:1},e.getItemType=function(n){return n.indexOf("%2A")!=-1?e.ItemTypes.regexp:e.ItemTypes.domain},e.normalize=function(e){return e.replace("%2A","*")},e.addElementToList=function(n,t,r,i){var o={value:t,type:e.getItemType(t)};return o.type==e.ItemTypes.regexp&&(o.value=e.normalize(o.value)),e.addOrUpdateElement(n,o,r,i)},e.addOrUpdateElement=function(n,t,r,i){var o,a=chrome.storage.sync;if(t.value.indexOf("*")==-1){var l=t.value;/^https?:\/\//.test(l)||(l="http://"+l);try{o=new URL(l)}catch(e){return Log.i("incorrect url="+l),r(!1)}t.value=o.hostname}else Log.i("domain with regular expression "+t.value),t.type=e.ItemTypes.regexp;Log.i("Element "+t.type+", name: "+t.value),a.get("list-"+n,function(o){var l=o["list-"+n],u=[];void 0!=l&&l instanceof Array&&(u=l);for(var s=0,c=u.length;s<c;s++)if(u[s].value===t.value){Log.i("removing duplicate element in this list: "+JSON.stringify(l[s])),i(u[s].id),l.splice(s,1);break}if(void 0===t.id)t.id=e.generateId(),u.splice(0,0,t);else for(var s=0,c=u.length;s<c;s++)if(u[s].id===t.id){u[s]=t;break}var d={};d["list-"+n]=u,a.set(d,function(){return Log.i("store function completed"),r(t)})});var u=n===e.Types.white?e.Types.black:e.Types.white;e.removeElementByValue(u,t.value,function(e){null!==e&&i(e)})},e.elementByUrl=function(n,t,r){e.getGroupedElements(n,function(e){if(e){if(0===e.length)return r(!1);var n;try{n=new URL(t)}catch(e){return Log.i("incorrect url="+t),r(!1)}var i=n.hostname[0]+n.hostname[1];if(void 0===e.domains&&void 0===e.regexp)return r(!1);if(void 0!=e.domains&&void 0!=e.domains[i]){var o=e.domains[i].indexOf(n.hostname);if(o!=-1)return r(e.domains[i][o])}if(void 0!=e.regexp)for(var a=0;a<e.regexp.length;a++){var l=e.regexp[a],u=new RegExp(l.replace(/\./g,"\\.").replace(/\*/g,"(.*)"));if(u.test(n.hostname))return r(l)}return r(!1)}})},e.contains=function(n,t,r){e.elementByUrl(n,t,function(e){return r(!!e)})},e.removeElementById=function(e,n,t){var r=chrome.storage.sync;r.get("list-"+e,function(i){var o=i["list-"+e];if(void 0==o||!(o instanceof Array))return t(null);for(var a=0,l=o.length;a<l;a++)if(o[a].id==n){Log.i("removing element: "+JSON.stringify(o[a])),o.splice(a,1);var u={};u["list-"+e]=o,r.set(u,function(){return Log.i("store function completed"),t(n)});break}return Log.i("object did'n removed, id not found"),t(null)})},e.removeElementByValue=function(e,n,t){var r=chrome.storage.sync;r.get("list-"+e,function(i){var o=i["list-"+e];if(void 0===o||!(o instanceof Array))return t(null);for(var a=0,l=o.length;a<l;a++)if(o[a].value===n){var u=o[a].id;Log.i("removing element: "+JSON.stringify(o[a])),o.splice(a,1);var s={};s["list-"+e]=o,r.set(s,function(){return Log.i("store function completed"),t(u)});break}return Log.i("object did'n removed, id not found"),t(null)})}};