var Auth=new function(){function e(e){d=!0,chrome.storage.sync.get(m,function(n){for(var t=0,o=m.length;t<o;t++){var r=m[t];c[r]=n[r]}Log.i("loaded auth data "+JSON.stringify(c)),d=!1,e&&e()})}function n(){for(var e={},n=0,t=m.length;n<t;n++){var o=m[n];e[o]=c[o]}Log.i("save auth data: "+JSON.stringify(e)),l=!0,chrome.storage.sync.set(e)}function t(){return c.token&&Math.floor(Date.now()/1e3)<c.tokenValidUntil}function o(e){return c.permanentToken?void Api.send(Api.Commands.TOKEN_RENEW,{permanentToken:c.permanentToken},function(t,o){return c.token=o.token,c.tokenValidUntil=Math.floor(Date.now()/1e3)+o.expire-60,n(),e(c.token)}):void r(e)}function r(e){c.deviceId||(c.deviceId=i()),c.username="",Api.send(Api.Commands.REGISTER,{deviceId:c.deviceId},function(t,o){return c.token=o.token,c.tokenValidUntil=Math.floor(Date.now()/1e3)+o.expire-60,c.permanentToken=o.permanentToken,o.isAutoGenerated||(c.username=o.username),n(),e(c.token)})}function a(e,n){Log.i("attempt to login with username "+e+" and pt "+n),c.permanentToken=n,c.username=e,o(function(){chrome.extension.sendMessage({command:"usernameChanged",username:e})})}function i(){for(var e="",n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=0;t<16;t++)e+=n.charAt(Math.floor(Math.random()*n.length));return e}function u(){e()}var s=this,m=["token","tokenValidUntil","permanentToken","username","deviceId"],c={token:null,tokenValidUntil:null,permanentToken:null,username:null,deviceId:null};chrome.runtime.onMessageExternal.addListener(function(e,n,t){"authorize"===e.command&&(e.permanentToken&&""!=e.permanentToken&&e.username&&""!=e.username?(a(e.username,e.permanentToken),t({complete:!0})):t({complete:!1}))}),chrome.storage.onChanged.addListener(function(n,t){if("sync"==t){for(var o=!1,r=0,a=m.length;!o&&r<a;r++){var i=m[r];o=o||i in n}o&&!l&&e(),l=!1}}),chrome.extension.onMessage.addListener(function(e,n,t){switch(e.command){case"username":return t({username:c.username}),!1;case"logout":return s.logout(),t({username:c.username}),!1}});var d=!1,l=!1;s.getToken=function(n){return d?void setTimeout(function(){s.getToken(n)},50):t()?n(c.token):void e(function(){return t()?n(c.token):void o(n)})},s.resetToken=function(){c.token=null,c.tokenValidUntil=0},s.getUsername=function(){return c.username},s.logout=function(){Log.i("logout"),c.username="",r(function(){chrome.extension.sendMessage({command:"usernameChanged",username:""})})},u()};