var Connection=(new function(){function e(e,n,t){switch(e.command){case"getCountries":return c.getCountries(t);case"getConnectionInfo":return c.getConnectionInfo(t);case"selectCountry":return c.selectCountry(e.country);case"usernameChanged":c.countries=[]}}function n(e,n,t){"updateCountries"===e.command&&(c.countries=[],t({complete:!0}))}function t(e){for(var n=0,t=Connection.countries.length;n<t;n++)if(c.countries[n].code===e)return c.countries[n]}function o(){c.lastSelectedCountryCode=localStorage.getItem("lastSelectedCountryCode")}function r(){localStorage.setItem("lastSelectedCountryCode",c.lastSelectedCountryCode)}var c=this;c.lastSelectedCountryCode=null,c.selectedCountry=null,c.countries=[],c.isFull=!1,c.currentConnection=null,c.init=function(){return o(),chrome.runtime.onMessage.addListener(e),chrome.runtime.onMessageExternal.addListener(n),c},c.getConnectionInfo=function(e){return c.currentConnection?(e(c.currentConnection),!1):(Api.send(Api.Commands.IP,{},function(n,t){return 200==n&&t.isVpn?(c.currentConnection=t,e(t)):void c.getCountries(function(){c.currentConnection={countryCode:c.lastSelectedCountryCode,isVpn:!1},e(c.currentConnection)})}),!0)},c.updateConnectionInfo=function(e){return c.currentConnection=null,e?c.getConnectionInfo(e):c.getConnectionInfo(function(e){chrome.runtime.sendMessage({command:"connectionInfoEvent",countryCode:e.countryCode,isVpn:e.isVpn})}),!0},c.getCountries=function(e){return c.countries.length>0?(c.selectedCountry||(c.selectedCountry=t(c.lastSelectedCountryCode),c.selectedCountry||(c.selectedCountry=c.countries[0],c.lastSelectedCountryCode=c.countries[0].code,r())),e({countries:c.countries,isFull:c.isFull}),!1):(Api.send(Api.Commands.CONNECTIONS,{protocol:"proxy"},function(n,o){localStorage.setItem("connectionUsername",o.connectionUsername),localStorage.setItem("connectionPassword",o.connectionPassword),c.countries=o.countriesAvailable,c.isFull=0===o.countriesUnavailable.length,c.selectedCountry=t(c.lastSelectedCountryCode),c.selectedCountry||(c.selectedCountry=c.countries[0],c.lastSelectedCountryCode=c.countries[0].code,r()),e({countries:c.countries,isFull:c.isFull})}),!0)},c.selectCountry=function(e){c.lastSelectedCountryCode=e,r(),c.selectedCountry=t(e),Proxy.update()},c.getConnectionString=function(e){c.getCountries(function(){for(var n="",t=0;t<c.selectedCountry.servers.length;t++){var o=c.selectedCountry.servers[t];n+="HTTPS "+o.hostname+":"+o.port+"; "}e(n)})}}).init();